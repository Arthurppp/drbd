#!/bin/sh
#
# to be managed by heartbeat.
# description: Mounts and unmounts the cluster filesystem
#	  
# Copyright (C) 1999 2000, Philipp Reisner <philipp@linuxfreak.com>.
# Initial author.
#
# Copyright (C) 2000, Fábio Olivé Leite <olive@conectiva.com.br>
# Changes to support multiple devices and different distributions.
# Changes to increase robustness and exit with proper error values.
#
# Copyright (C) 2000, Thomas Mangin <thomas.mangin@free.fr>
# Mainly moved to drbdc only keep the start, stop, restart section

INSTALL="/etc/ha.d/resource.d"
. $INSTALL/drbd_commun $*

# See how we were called.
case "$1" in
	start)
		$is_force=`echo "$MODE" | grep -i "force" | wc -l | sed -e"s/ //g"`
		$is_restore=`echo "$MODE" | grep -i "restore" | wc -l | sed -e"s/ //g"`
		$is_force=`echo "$MODE" | grep -i "negotiate" | wc -l | sed -e"s/ //g"`

		if [ $is_force -eq 1 ]; then
			param=`echo $* | sed -e"s/start/master/g"`
		elif [ $is_restore -eq 1 ]; then
			isMasterBoot $RESOURCE
			MASTER=$?

			isRemotePrimary $RESOURCE
			REMOTE_PRIMARY=$?

			if [ "$MASTER" -eq 1 -a "$REMOTE_PRIMARY" -ne 1 ]; then
				param=`echo $* | sed -e"s/start/master/g"`
			else
				param=`echo $* | sed -e"s/start/slave/g"`
			fi
		elif [ $is_negotiate -eq 1 ]; then
			isWorkingPrimary $RESOURCE
			PRIMARY=$?

			isWorkingSecondary $RESOURCE
			SECONDARY=$?

			haveRemotePrimary $RESOURCE
			RPRIMARY=$?

			haveRemoteSecondary $RESOURCE
			RSECONDARY=$?

			if [ "$SECONDARY" -eq 1 -a "$RPRIMARY" ]; then
				param=`echo $* | sed -e"s/start/master/g"`
			elif [ "$RSECONDARY" -eq 1 -a "$SECONDARY" -eq 1 ]; then
				param=`echo $* | sed -e"s/start/slave/g"`
			else
				# TODO:Don't know if it can happen
				failure "This must never happend ??"
				exit 1
			fi
		else
			failure "$0 unknow mode '$MODE'"
		fi

		$INSTALL/drbdc $param

		RV=$?
		[ $RETVAL -eq 0 ] && RETVAL=$RV
		;;

	stop)
		param=`echo $* | sed -e"s/stop/slave/g"`
		$INSTALL/drbdc $param

		RV=$?
		[ $RETVAL -eq 0 ] && RETVAL=$RV
		;;
		
	restart)
		$0 stop
		$0 start

		# TODO: A real return check
		RV=$?
		[ $RETVAL -eq 0 ] && RETVAL=$RV
		;;
	status)
		$INSTALL/drbdc $*
		RETVAL=$?
		;;

	*)
		echo "Usage: $0 [resource] {start|stop|restart|status}"
		RETVAL=1
		;;
esac

exit $RETVAL
