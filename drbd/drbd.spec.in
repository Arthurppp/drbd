# "uname -r" output of the kernel to build for, the running one
# if none was specified with "--define 'kernelversion <uname -r>'"
# PLEASE: provide both (correctly) or none!!
%{!?kernelversion: %{expand: %%define kernelversion %(uname -r)}}
%{!?kdir: %{expand: %%define kdir /lib/modules/%(uname -r)/build}}

#
# this results in strange names for e.g. smp4G, psmp,
# -smp-lge or whatnot.
#-- 
# %define kversion %(echo %{kernelversion} | sed -e s/smp// -)
# %define krelver  %(echo %{kversion} | tr -s '-' '_')
# %if %(echo %{kernelversion} | grep -c smp)
#   %{expand:%%define ksmp -smp}
# %endif
#-- 
# so I choose to have it thus:
%define krelver  %(echo %{kernelversion} | tr -s '-' '_')

Name: drbd
Summary: Distributed Redundant Block Device driver for Linux
Version: 
Release: 3
Source: %{name}-%{version}.tar.gz
Vendor: DRBD 
License: GPL
ExclusiveOS: linux
Group: System Environment/Kernel
Packager: 
Requires: kernel
Provides: %{name}
URL: http://www.drbd.org/ 
BuildRoot: %{_tmppath}/%{name}-%{version}-root

%description
Drbd is a distributed replicated block device. It mirrors a
block device over the network to another machine. Think of it
as networked raid 1. It is a building block for setting up
high availability (HA) clusters.

Authors:
--------
    Philipp Reisner <philipp.reisner@linbit.com> - Primary Author
    Lars Ellenberg  <l.g.e@web.de>

#%package -n kernel%{?ksmp}-module-drbd
# I choose to have the kernelversion as part of the package name!
# drbd is prepended...
%package km-%{krelver}
Summary: Kernel driver for DRBD.
#Release: %{release}_%{krelver}
Group: System Environment/Kernel
Requires: %{name} = %{version}, /sbin/depmod
#%{?ksmp:Provides: kernel-module-drbd = %{version}-%{release}_%{krelver}}

#%description -n kernel%{?ksmp}-module-drbd
%description km-%{krelver}
This module is the kernel-dependant driver for DRBD.  This is split out so
that multiple kernel driver versions can be installed, one for each
installed kernel.

%prep
%setup
test -d %{kdir}/.
test $(echo -e "#include <linux/version.h>\ndrbd_kernel_release UTS_RELEASE" |
       gcc -nostdinc -E -P -I%{kdir}/include - |
       sed -ne 's/^drbd_kernel_release "\(.*\)".*/\1/p') = %{kernelversion}

%build
echo kernelversion=%{kernelversion}
echo kversion=%{kversion}
echo krelver=%{krelver}
mkdir -p %{buildroot}

skip_doc="%{?skip_make_doc:DB2MAN= DB2HTML= DB2PS= DB2PDF=}"
make clean $skip_doc
# note: MANDIR is not used anywhere in the makefiles
#       maybe this should be changed
make all PREFIX=%{buildroot}/ MANDIR=%{_mandir} KDIR=%{kdir} $skip_doc

# sanity check
test %{kernelversion} = $(<drbd/.kernelrelease)

%install
make PREFIX=%{buildroot}/ MANDIR=%{_mandir} install
cd documentation
mv HOWTO HOWTO.orig
mkdir HOWTO
find HOWTO.orig/ -name "*.html" -exec cp -p '{}' HOWTO \;
cd ../drbd
mv .kernel.config.gz k-config-%{kernelversion}.gz

FILELIST="%{_builddir}/%{name}-%{version}/file.list"
cd %{buildroot}
#
# this is because /etc/init.d != /etc/rc.d != /etc/rc.d/init.d ...
# you may want to edit this, or the file list below ;)
#
find etc/ -name drbd -printf "/%p\n" > "$FILELIST"
# on suse/united we have additionally:
test -e sbin/rcdrbd && echo "/sbin/rcdrbd" >> "$FILELIST"

## If I only wanted to include the module, not all the directories
## I'd then say  %files -n kernel%{?ksmp}-module-drbd -f $FILELIST.mod below
#find lib/ -name "drbd.*" -printf "/%p\n" > "$FILELIST.mod"

#
# and I only want to install a hint to the example conf
#
cat <<___ > etc/drbd.conf
#
# please have a a look at the example configuration file in
# %{_docdir}/drbd.conf
#
___

%clean
[ -n $RPM_BUILD_ROOT -a "$RPM_BUILD_ROOT" != "/" ] && rm -rf $RPM_BUILD_ROOT

%files -f %{_builddir}/%{name}-%{version}/file.list
%defattr(755,root,root)
/sbin/drbdsetup
/etc/ha.d/resource.d/datadisk

%defattr(644,root,root)
%config(noreplace) /etc/drbd.conf

%defattr(700,root,root)
%dir /var/lib/drbd

%defattr(-,root,root)
%{_mandir}/man8/datadisk.8.gz
%{_mandir}/man8/drbd.8.gz
%{_mandir}/man8/drbdsetup.8.gz
%{_mandir}/man5/drbd.conf.5.gz
%{_mandir}/ja/man8/datadisk.8.gz
%{_mandir}/ja/man8/drbd.8.gz
%{_mandir}/ja/man8/drbdsetup.8.gz
%{_mandir}/ja/man5/drbd.conf.5.gz
%{_mandir}/pt_BR/man8/datadisk.8.gz
%{_mandir}/pt_BR/man8/drbd.8.gz
%{_mandir}/pt_BR/man8/drbdsetup.8.gz
%{_mandir}/pt_BR/man5/drbd.conf.5.gz
%doc scripts/drbd.conf
%doc documentation/NFS-Server-README.txt
%doc documentation/drbd-article.html
%doc documentation/HOWTO
%doc COPYING
%doc README

#%files -n kernel%{?ksmp}-module-drbd
%files km-%{krelver}
%defattr(-,root,root)
/lib/modules/%{kernelversion}/
%doc drbd/k-config-%{kernelversion}.gz

%post
uname -r | grep BOOT || /sbin/depmod -a > /dev/null 2>&1 || true

chkconfig --add drbd

%preun
if type -p service ; then
	service drbd stop
fi
if type -p rcdrbd ; then
	rcdrbd stop
fi

lsmod | grep drbd > /dev/null 2>&1
if [ $? -eq 0 ]; then
	rmmod drbd
fi

if [ $1 -eq 0 ]; then
	chkconfig --del drbd
fi

#%post -n kernel%{?ksmp}-module-drbd
%post km-%{krelver}
/sbin/depmod -a -F /boot/System.map-%{kernelversion} %{kernelversion} >/dev/null 2>&1 || true

#%postun -n kernel%{?ksmp}-module-drbd
%postun km-%{krelver}
/sbin/depmod -a -F /boot/System.map-%{kernelversion} %{kernelversion} >/dev/null 2>&1 || true

%changelog
* Fri Mar 10 2004 Philipp Reisner <philipp.reisner@linbit.com> [0.6.12-1]
- With the non-blocking IO hints, a bug was introduced that could
  lead to partially sent IO hints. -> loss of connetion. 
  This issue is fixed now.
- Fix to range check of nice value in drbdsetup
- Updates to build system (Makefile, Makefile.SuSE-9.0)

* Fri Feb  6 2004 Lars Ellenberg <Lars.Ellenberg@linbit.com> [0.6.11-1]
- drbd (0.6.11-1)
- fix for timeout when asender is dead
- fix for blocking bottom halves or bdflush and the like in
  low memory situations
- included register_ioctl32_conversion for sparc64,ppc64,x86_64
- improved documentation
- improved build system
- added Makefile-SuSE-9.0, which I use to generate all rpms for
  the shipped SuSE kernels
- because "kernel-module-drbd-0.6.10+cvs-3_2.4.21-166_p.i586.rpm"
  looks too weird, I choose to have the kernel part named like
  "drbd-km-2.4.21-166-psmp-0.6.10+cvs-3"

* Wed Feb  4 2004 Lars Ellenberg <Lars.Ellenberg@linbit.com>
- merged Sean Reifschneiders changes with my own changes which already
  where in cvs

* Tue Feb  3 2004 Sean Reifschneider <jafo-rpms@tummy.com> [0.6.10-2]
- Moved DRBD driver out into "kernel-module-drbd" RPM.
- The kernel-module-drbd module has a release based on the kernel name,
  allowing one instance of kernel-module-drbd to be installed for each
  kernel on the box.
- Removed the "drbd.o.old" pre/post code.

* Wed Dec 12 2003 15:10:44 +0200 Philipp Reisner <phil@linbit.com>
- drbd (0.6.10-1)
- With 0.6.9 there was a bug introduced which prevented the sending 
  of ACK packets during resync. Fixed.
- A fix to drbdsetup's wait_connect command.
  Replaced all invocations of the sleep_on() family functions with the 
  invocations of the wait_event() macros. This removes lost wakup events 
  and race conditions.
- New implementation of drbd_wait_ee(). This makes the 
  "(BUG?) Moving bh=%p to done_ee" go away.
- Handle the case if vmalloc() of the bitmap fails.

* Wed Nov 26 2003 17:39:19 +0100 Philipp Reisner <phil@linbit.com>
- drbd (0.6.9-1)
- New module build system (using kernel source tree build system)
- New net section option 'ko-count'. It allows you to kick out a 
  secondary node which does no longer process data in acceptable time. 
  Its default value is 0 which disables this feature.
- Changing syncgroups while resync runs has shows now the correct behaviour.
- In case thread creations fails DRBD would deadlock on its own
  semaphore. Fixed now.
- BKL is no longer used on Linux-2.4.x.
- Now you can stack mapping block devices like LVM2 (and maybe md) on 
  top of drbd (a one character fix).
- drbdsetup wait_connect on a StandAlone node looked like a timeout and
  forced primary. fixed.
- if drbdsetup wait_* in fact did timeout this looked like a failed ioctl.
  this bug was newly introduced in 0.6.8. fixed.
- A fix to a race in _drbd_alloc_ee(). You could trigger this race if
  your filesystem uses a blocksize < 4K and your machine has multiple CPUs.
  By Eric W. Biederman.
- A maybe bugfix regarding calls to free_page() by Eric W. Biederman.
- A cleanup patch to drbd_process_done_ee() by Eric W. Biederman.

* Mon Oct 20 2003 11:43:00 +0100 Philipp Reisner <phil@linbit.com>
- drbd (0.6.8-1)
- Two fixes to the sync-group functionality.

* Mon Jul 28 2003 14:40:26 +0100 Philipp Reisner <phil@linbit.com>
- drbd (0.6.7-1)
- A fix to a bug that could cause data corruption if you use a 
  other blocksize than 4k to access the DRBD device.
- A fix to a SMP race in the syncer code. The problem was tirggered
  when using DRBD on QLogic fiber channel adapters.
- Replaced various calls to sleep_on() variants with the wait_event()
  macros. -- This removes potential (, non-critical) SMP races.
- This release includes the sync-group option.

* Mon Jul 28 2003 14:40:26 +0100 Philipp Reisner <phil@linbit.com>
- drbd (0.6.6-1)
- In the 0.6.5 release the secondary_remote command was badly broken,
  it succeeded when it should fail silently. This is fixed now.
- Probabely in all previous releases, the resyncer thread did not
  exit properly if the secondary node goes away during resync. 
  This was not fatal sind the resyncher thread did exit at soon
  as it gets a network error. This is fixed now.
- Some new switches to the drbd script.

* Sun Jul 06 2003 13:29:00 +0100 Philipp Reisner <phil@linbit.com>
- drbd (0.6.5-1)
- Improvements to the build system
- Now it is possible to tune the socket send buffer size via drbdsetup/
  drbd.conf. This is especially usefull for WAN mirroring / using
  protocol A.
- Compatibility code to compile DRBD under RedHat 9.0 (RH's version of
  Linux-2.4.20)
- Improved sample drbd.conf file

* Thu May 01 2003 21:00:00 +0100 Philipp Reisner <phil@linbit.com>
- drbd (0.6.4-1)
- Reworked build system (i.e. better Makefiles)
- SyncAll works forward instead of backwards. Improves performance on
  some storage controlers.
- Reworked /etc/init.d/drbd script (i.e. better support of
  different bash releases)

* Thu Mar 20 2003 20:23:40 +0100 Philipp Reisner <phil@linbit.com>
- drbd (0.6.3-1)
-  * Lockup of primary if secondary fails during resync. Fixed. (Stupid!)
-  * Probabely SMP only deadlock in the drop-conection code path.
-  * Improved connect code. (The old code could trap into a distributed
-    deadlock, resulting in an endless connect/disconnect loop.)
-  * The 'BitMap too small bug' was actually caused by a patch in
-    SuSE's distribution kernel. This patch makes DRBD 'more' compatible
-    with SuSE's kernel.
-  * Improved code to allocate buffers for the rsynchronisation process.
-    The old code allocated physical adjacent pages although the syncer
-    does not need them! The old code could fail under high memory pressure.

* Tue Feb 11 2003 15:58:49 +0100 Philipp Reisner <phil@linbit.com>
-  drbd (0.6.2-1)
-
-  * SMP fix in drbd_dio_end_sec()
-  * /etc/init.d/drbd knows about returncodes of fsck
-  * SUSE style rcdrbd
-  * Fixes for uninstall Target of the Makefiles.

* Thu Aug 15 2002 Omar Kilani <ok@mailcall.com.au>
- Do not chkconfig --del on an update.

* Wed Aug 14 2002 Omar Kilani <ok@mailcall.com.au>
- Initial revision (a very hacked up e1000.spec file)
